---
title: "Kaggle Survey 2017"
author: "Josh Goldberg"
date: "11/7/2017"
output: github_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

## Load Libraries
```{r Load Libraries}
library(tidyverse)
library(gridExtra)
library(scales)
library(forcats)
library(rlang)
library(RColorBrewer)
library(viridis)
```

## Read Data
```{r Read Data}
MC_raw_data <- read_csv('multipleChoiceResponses.csv')
FF_raw_data <- read_csv('freeformResponses.csv')
schema <- read_csv('schema.csv')
conversion_rates <- read_csv('conversionRates.csv')

```

We'll start with a quick glimpse of the data.
```{r}
dim(MC_raw_data)
```

This dataset has 16,716 rows (survey entries) and 228 columns.

Create clean data frame to manipulate.
```{r}
clean_MC_data <- MC_raw_data
clean_FF_data <- FF_raw_data
```

## Response by Country
*Exclude NA*
```{r Country}
ggplot(filter(clean_MC_data, !is.na(Country))) +
  geom_bar(aes(x = fct_infreq(Country), y = ..prop.., group = 1), fill = '#2178a3', color = 'white') +
  labs(x = 'Country', y = 'Responses',
       title = 'Survey Responses By Country') +
  scale_y_continuous(labels = percent) +
  theme(plot.title = element_text(size = 14, face = "bold",
                                       color = "black", vjust = -1)) +
  theme(plot.subtitle = element_text(size = 8, face = "italic",
                                          color = "black")) +
  theme(axis.text.x = element_text(size = 10, angle = 50, hjust = 1)) +
  theme(axis.title.x = element_text(size = 10, vjust = -0.2)) +
  theme(axis.title.y = element_text(size = 10)) +
  theme(panel.background = element_rect(fill = "white")) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 10, angle = 50, hjust = 1))
```

## Response by Gender
*Excluded NA*
```{r Gender}
ggplot(filter(clean_MC_data, !is.na(GenderSelect))) +
  geom_bar(aes(x = fct_infreq(GenderSelect), y = ..prop.., group = 1), fill = '#2178a3', color = 'white') +
  labs(x = 'Gender', y = 'Responses',
       title = 'Survey Responses By Gender') +
  scale_y_continuous(labels = percent) +
  scale_x_discrete(labels = c('Male', 'Female', 'A Different Identity', 'Non-conforming')) +
  theme(plot.title = element_text(size = 14, face = "bold",
                                       color = "black", vjust = -1)) +
  theme(plot.subtitle = element_text(size = 8, face = "italic",
                                          color = "black")) +
  theme(axis.text.x = element_text(size = 10, angle = 50, hjust = 1)) +
  theme(axis.title.x = element_text(size = 10, vjust = -0.2)) +
  theme(axis.title.y = element_text(size = 10)) +
  theme(panel.background = element_rect(fill = "white")) +
  theme_minimal() 
```


## Response by Country and Gender
*Excluded NA*
```{r Country and Gender}
ggplot(filter(clean_MC_data, !is.na(Country) & !is.na(GenderSelect))) +
  geom_bar(aes(x = fct_infreq(Country), fill = GenderSelect), position = 'fill') +
  labs(x = 'Country', y = 'Proportion',
       title = 'Survey Responses by Country and Gender') +
  scale_y_continuous(labels = percent) +
  scale_fill_brewer(type = 'div', palette = 7, 
                    guide = guide_legend(title = NULL, keywidth = .75, keyheight = .75), name = 'Gender', 
                    breaks = c('A different identity', 'Female', 'Male',
                    'Non-binary, genderqueer, or gender non-conforming'),
                    labels = c('Different Identity', 'Female', 'Male', 'Non-conforming')) +
  theme_minimal() +
  theme(legend.position = "top") +
  theme(axis.text.x = element_text(size = 10, angle = 50, hjust = 1))
```

##Age Distribution
*Ages between 5 and 90; Excluded NA*
```{r Age}
ggplot(filter(clean_MC_data, !is.na(Age), !is.na(GenderSelect), Age > 5 & Age < 90)) +
  geom_histogram(aes(x = Age, y = ..density..), fill = '#2178a3', color = 'white') +
  geom_density(aes(x = Age, color = I('#ee5b4b'))) +
  guides(color = "none") +
  scale_y_continuous(labels = percent) +
  labs(x = 'Age', y = 'Responses',
       title = 'Survey Responses By Age') +
  theme_minimal()
```

##Age Distribution by Gender
*Ages between 5 and 90; Excluded NA*
```{r Age Facet}
clean_MC_data$GenderSelect <- factor(clean_MC_data$GenderSelect, labels = c('A different identity', 'Female', 'Male', 'Non-conforming'))
ggplot(filter(clean_MC_data, !is.na(Age), !is.na(GenderSelect), Age > 5 & Age < 90)) +
  geom_histogram(aes(x = Age, y = ..density..), fill = '#2178a3', color = 'white') +
  geom_density(aes(x = Age, color = I('#ee5b4b'))) +
  guides(color = "none") +
  facet_wrap(~ GenderSelect) +
  scale_y_continuous(labels = percent) +
  labs(x = 'Age', y = 'Responses',
       title = 'Survey Responses By Age') +
  theme_minimal()
  

```


```{r}
# A function to analyze questions where you choose only one answer
chooseOne = function(question, filteredData = clean_MC_data) {

  filteredData %>% 
    # Remove any rows where the respondent didn't answer the question
    filter(!UQ(sym(question)) == "") %>% 
    # Group by the responses to the question
    group_by_(question) %>% 
    # Count how many respondents selected each option
    summarise(count = n()) %>% 
    # Calculate what percent of respondents selected each option
    mutate(percent = (count / sum(count)) * 100) %>% 
    # Arrange the counts in descending order
    arrange(desc(count))
}

# A function to analyze questions where you choose multiple answers
chooseMultiple = function(question, filteredData = cleanMCData){

  filteredData %>% 
    # Remove any rows where the respondent didn't answer the question
    filter(!UQ(sym(question)) == "") %>%
    # Remove all columns except question
    select(question) %>% 
    # Add a column with the initial number of respondents to question
    mutate(totalCount = n()) %>% 
    # Split multiple answers apart at the comma, but ignore commas inside parentheses
    mutate(selections = strsplit(as.character(UQ(sym(question))), 
                                 '\\([^)]+,(*SKIP)(*FAIL)|,\\s*', perl = TRUE)) %>%
    # Split answers are now nested, need to unnest them
    unnest(selections) %>% 
    # Group by the selected responses to the question
    group_by(selections) %>% 
   # Count how many respondents selected each option
    summarise(totalCount = max(totalCount),
              count = n()) %>% 
    # Calculate what percent of respondents selected each option
    mutate(percent = (count / totalCount) * 100) %>% 
    # Arrange the counts in descending order
    arrange(desc(count))
  
}
```

```{r}
chooseOne('GenderSelect')

```


```{r}
library(knitr)
opts_chunk$set(results = "asis")
summary(clean_MC_data$Age)
```



















